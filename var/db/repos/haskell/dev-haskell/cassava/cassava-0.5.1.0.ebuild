# Copyright 1999-2018 Gentoo Authors
# Distributed under the terms of the GNU General Public License v2

EAPI=6

# ebuild generated by hackport 0.5.5.9999

CABAL_FEATURES="lib profile haddock hoogle hscolour test-suite"
inherit haskell-cabal versionator

DESCRIPTION="A CSV parsing and encoding library"
HOMEPAGE="https://github.com/hvr/cassava"
SRC_URI="https://hackage.haskell.org/package/${P}/${P}.tar.gz"

LICENSE="BSD"
SLOT="0/${PV}"
KEYWORDS="~amd64 ~x86"
IUSE=""

RDEPEND=">=dev-haskell/attoparsec-0.11.3.0:=[profile?] <dev-haskell/attoparsec-0.14:=[profile?]
	>=dev-haskell/bytestring-builder-0.10.8:=[profile?] <dev-haskell/bytestring-builder-0.11:=[profile?]
	>=dev-haskell/fail-4.9:=[profile?] <dev-haskell/fail-4.10:=[profile?]
	<dev-haskell/hashable-1.3:=[profile?]
	>=dev-haskell/nats-1:=[profile?] <dev-haskell/nats-1.2:=[profile?]
	>=dev-haskell/only-0.1:=[profile?] <dev-haskell/only-0.1.1:=[profile?]
	>=dev-haskell/scientific-0.3.4.7:=[profile?] <dev-haskell/scientific-0.4:=[profile?]
	>=dev-haskell/semigroups-0.18:=[profile?] <dev-haskell/semigroups-0.19:=[profile?]
	<dev-haskell/text-1.3:=[profile?]
	>=dev-haskell/text-short-0.1:=[profile?] <dev-haskell/text-short-0.2:=[profile?]
	<dev-haskell/unordered-containers-0.3:=[profile?]
	>=dev-haskell/vector-0.8:=[profile?] <dev-haskell/vector-0.13:=[profile?]
	>=dev-lang/ghc-7.4.1:=
"
DEPEND="${RDEPEND}
	>=dev-haskell/cabal-1.12
	test? ( dev-haskell/hunit
		>=dev-haskell/quickcheck-2.10
		>=dev-haskell/quickcheck-instances-0.3.12
		>=dev-haskell/test-framework-0.8
		>=dev-haskell/test-framework-hunit-0.3
		>=dev-haskell/test-framework-quickcheck2-0.3 )
"

src_prepare() {
	default

	cabal_chdeps \
		'bytestring <  0.10.4' 'bytestring' \
		'containers >= 0.4.2 && < 0.6' 'containers >= 0.4.2' \
		'HUnit < 1.7' 'HUnit' \
		'QuickCheck == 2.10.*' 'QuickCheck >= 2.10' \
		'quickcheck-instances >= 0.3.12 && < 0.4' 'quickcheck-instances >= 0.3.12' \
		'test-framework == 0.8.*' 'test-framework >= 0.8' \
		'test-framework-hunit == 0.3.*' 'test-framework-hunit >= 0.3' \
		'test-framework-quickcheck2 == 0.3.*' 'test-framework-quickcheck2 >= 0.3'
}

src_configure() {
	# The bytestring--LT-0_10_4 is supposed to be automatic.  This is
	# a workaround for Cabal-2.2.0.1 setting it wrong, from the build.log
	# Dependency bytestring >=0.9.2 && <0.11: using bytestring-0.10.8.2
	# ...
	# Flags chosen: bytestring--lt-0_10_4=True
	local BV=$(ghc-pkg latest bytestring | cut -d'-' -f 2)
	local BS
	$(version_is_at_least "0.10.4" "${BV}") && BS="-" || BS="+"

	haskell-cabal_src_configure \
		--flag="${BS}bytestring--LT-0_10_4"
}
